{% extends 'base.html' %}
{% load static %}

{% block title %}Upload Photo - ShutterSpace{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
    <div class="card shadow-sm form-contrast">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0">
                    <i class="fa-solid fa-camera me-2"></i>Upload New Photo
                </h3>
            </div>
            <div class="card-body">
                <!-- Overall form errors -->
                {% if form.non_field_errors %}
                    <div class="alert alert-danger" role="alert">
                        <i class="fa-solid fa-exclamation-triangle me-2"></i>
                        <strong>Please correct the following:</strong>
                        {{ form.non_field_errors }}
                    </div>
                {% endif %}

                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <!-- Image Upload Field -->
                    <div class="mb-4">
                        <label for="{{ form.image.id_for_label }}" class="form-label fw-bold">
                            {{ form.image.label }}
                        </label>
                        {{ form.image }}
                        
                        <!-- File size and type information -->
                        <div id="fileInfo" class="mt-2 d-none">
                            <div class="alert alert-info mb-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fa-solid fa-file-image me-2"></i>
                                        <span id="fileName"></span>
                                    </div>
                                    <div>
                                        <strong id="fileSize"></strong>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <div class="progress" style="height: 6px;">
                                        <div id="sizeBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                    </div>
                                    <small class="text-muted">Maximum file size: 10 MB</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Error display for file validation -->
                        <div id="fileError" class="alert alert-danger d-none">
                            <i class="fa-solid fa-exclamation-triangle me-2"></i>
                            <span id="fileErrorMessage"></span>
                        </div>
                        
                        {% if form.image.help_text %}
                            <div class="form-text">
                                <i class="fa-solid fa-info-circle me-1"></i>{{ form.image.help_text }}
                            </div>
                        {% endif %}
                        {% if form.image.errors %}
                            <div class="invalid-feedback d-block">
                                <i class="fa-solid fa-times-circle me-1"></i>
                                {% for error in form.image.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Title Field -->
                    <div class="mb-3">
                        <label for="{{ form.title.id_for_label }}" class="form-label fw-bold">
                            {{ form.title.label }}
                        </label>
                        {{ form.title }}
                        {% if form.title.help_text %}
                            <div class="form-text">
                                <i class="fa-solid fa-info-circle me-1"></i>{{ form.title.help_text }}
                            </div>
                        {% endif %}
                        {% if form.title.errors %}
                            <div class="invalid-feedback d-block">
                                <i class="fa-solid fa-times-circle me-1"></i>
                                {% for error in form.title.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text text-muted">
                            <span id="titleCounter">0</span>/255 characters
                        </div>
                    </div>
                    
                    <!-- Description Field -->
                    <div class="mb-3">
                        <label for="{{ form.description.id_for_label }}" class="form-label">
                            {{ form.description.label }}
                        </label>
                        {{ form.description }}
                        {% if form.description.help_text %}
                            <div class="form-text">
                                <i class="fa-solid fa-info-circle me-1"></i>{{ form.description.help_text }}
                            </div>
                        {% endif %}
                        {% if form.description.errors %}
                            <div class="invalid-feedback d-block">
                                <i class="fa-solid fa-times-circle me-1"></i>
                                {% for error in form.description.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text text-muted">
                            <span id="descriptionCounter">0</span>/1000 characters
                        </div>
                    </div>
                    
                    <!-- Privacy Setting -->
                    <div class="mb-4">
                        <div class="form-check">
                            {{ form.is_public }}
                            <label class="form-check-label" for="{{ form.is_public.id_for_label }}">
                                {{ form.is_public.label }}
                            </label>
                            {% if form.is_public.help_text %}
                                <div class="form-text">
                                    <i class="fa-solid fa-info-circle me-1"></i>{{ form.is_public.help_text }}
                                </div>
                            {% endif %}
                        </div>
                        {% if form.is_public.errors %}
                            <div class="invalid-feedback d-block">
                                <i class="fa-solid fa-times-circle me-1"></i>
                                {% for error in form.is_public.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Submit Buttons -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% url 'home' %}" class="btn btn-outline-secondary me-md-2">
                            <i class="fa-solid fa-times me-1"></i>Cancel
                        </a>
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="fa-solid fa-upload me-1"></i>Upload Photo
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Client-side validation and character counters -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const titleField = document.getElementById('{{ form.title.id_for_label }}');
    const descriptionField = document.getElementById('{{ form.description.id_for_label }}');
    const imageField = document.getElementById('{{ form.image.id_for_label }}');
    const titleCounter = document.getElementById('titleCounter');
    const descriptionCounter = document.getElementById('descriptionCounter');
    const submitBtn = document.getElementById('submitBtn');
    
    // File information elements
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const sizeBar = document.getElementById('sizeBar');
    const fileError = document.getElementById('fileError');
    const fileErrorMessage = document.getElementById('fileErrorMessage');
    
    // File size limits
    const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10 MB in bytes
    const ALLOWED_TYPES = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
    
    // Format file size for display
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // File validation and info display
    function handleFileSelection() {
        const file = imageField.files[0];
        
        // Hide previous states
        fileInfo.classList.add('d-none');
        fileError.classList.add('d-none');
        imageField.classList.remove('is-invalid', 'is-valid');
        
        if (!file) return;
        
        let isValid = true;
        let errorMsg = '';
        
        // Check file type
        if (!ALLOWED_TYPES.includes(file.type)) {
            errorMsg = 'Please select a valid image file (JPEG, PNG, GIF, or WebP).';
            isValid = false;
        }
        
        // Check file size
        if (file.size > MAX_FILE_SIZE) {
            errorMsg = `File size (${formatFileSize(file.size)}) exceeds the maximum limit of 10 MB.`;
            isValid = false;
        }
        
        if (!isValid) {
            fileErrorMessage.textContent = errorMsg;
            fileError.classList.remove('d-none');
            imageField.classList.add('is-invalid');
            return;
        }
        
        // Display file information
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        
        // Update progress bar based on file size (0-100% relative to max size)
        const percentage = (file.size / MAX_FILE_SIZE) * 100;
        sizeBar.style.width = percentage + '%';
        
        // Color code the progress bar
        if (percentage < 50) {
            sizeBar.className = 'progress-bar bg-success';
        } else if (percentage < 80) {
            sizeBar.className = 'progress-bar bg-warning';
        } else {
            sizeBar.className = 'progress-bar bg-danger';
        }
        
        fileInfo.classList.remove('d-none');
        imageField.classList.add('is-valid');
    }
    
    // Character counters
    function updateTitleCounter() {
        const count = titleField.value.length;
        titleCounter.textContent = count;
        titleCounter.className = count > 255 ? 'text-danger fw-bold' : 'text-muted';
    }
    
    function updateDescriptionCounter() {
        const count = descriptionField.value.length;
        descriptionCounter.textContent = count;
        descriptionCounter.className = count > 1000 ? 'text-danger fw-bold' : 'text-muted';
    }
    
    // Event listeners for real-time feedback
    titleField.addEventListener('input', updateTitleCounter);
    descriptionField.addEventListener('input', updateDescriptionCounter);
    imageField.addEventListener('change', handleFileSelection);
    
    // Initialize counters
    updateTitleCounter();
    updateDescriptionCounter();
    
    // Form validation on submit
    const form = titleField.closest('form');
    form.addEventListener('submit', function(e) {
        let isValid = true;
        
        // File validation
        const file = imageField.files[0];
        if (!file) {
            fileErrorMessage.textContent = 'Please select an image to upload.';
            fileError.classList.remove('d-none');
            imageField.classList.add('is-invalid');
            isValid = false;
        } else if (file.size > MAX_FILE_SIZE) {
            fileErrorMessage.textContent = `File size (${formatFileSize(file.size)}) exceeds the maximum limit of 10 MB.`;
            fileError.classList.remove('d-none');
            imageField.classList.add('is-invalid');
            isValid = false;
        } else if (!ALLOWED_TYPES.includes(file.type)) {
            fileErrorMessage.textContent = 'Please select a valid image file (JPEG, PNG, GIF, or WebP).';
            fileError.classList.remove('d-none');
            imageField.classList.add('is-invalid');
            isValid = false;
        }
        
        // Title validation
        const title = titleField.value.trim();
        if (title.length < 3) {
            titleField.classList.add('is-invalid');
            isValid = false;
        } else {
            titleField.classList.remove('is-invalid');
            titleField.classList.add('is-valid');
        }
        
        // Description validation
        const description = descriptionField.value.trim();
        if (description.length > 1000) {
            descriptionField.classList.add('is-invalid');
            isValid = false;
        } else if (description.length > 0) {
            descriptionField.classList.remove('is-invalid');
            descriptionField.classList.add('is-valid');
        }
        
        if (!isValid) {
            e.preventDefault();
            submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Please fix errors above';
            submitBtn.classList.add('btn-danger');
            submitBtn.classList.remove('btn-primary');
            
            // Scroll to first error
            const firstError = form.querySelector('.is-invalid');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            setTimeout(() => {
                submitBtn.innerHTML = '<i class="fas fa-upload me-1"></i>Upload Photo';
                submitBtn.classList.remove('btn-danger');
                submitBtn.classList.add('btn-primary');
            }, 3000);
        } else {
            // Show upload progress
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Uploading...';
            submitBtn.disabled = true;
        }
    });
});
</script>
{% endblock %}