{% extends 'base.html' %}
{% load static %}

{% block title %}Profile - {{ owner.username }}{% endblock %}

{% block content %}
<!-- Hero Image Section -->
{% if profile.hero_image %}
<div class="profile-hero-section mb-4">
  <div class="profile-hero-image">
    <img
      src="{{ profile.hero_image.url }}?w_1200&h_400&c_fill&q_auto:eco&f_auto"
      alt="{{ owner.username }}'s hero image"
      class="hero-image"
      loading="lazy"
    />
    <div class="hero-overlay">
      <div class="hero-content">
        {% if profile and profile.avatar %}
        <img
          src="{{ profile.avatar.url }}?w_150&h_150&c_thumb&g_face&q_auto:eco&f_auto"
          class="hero-avatar rounded-circle"
          alt="{{ owner.username }}'s avatar"
          loading="lazy"
        />
        {% else %}
        <div class="hero-avatar-initials">{{ initials }}</div>
        {% endif %}
        <h1 class="hero-title">
          {{ profile.display_name|default:owner.username }}
        </h1>
        <p class="hero-subtitle text-break">
          {{ profile.bio|default:"Photography Portfolio" }}
        </p>
      </div>
    </div>
  </div>
</div>
{% endif %}

<div class="row">
  <div class="col-lg-3 mb-4">
    <div class="card profile-sidebar">
      <div class="card-body text-center sidebar-dark-bg">
        {% if not profile.hero_image %} {% if profile and profile.avatar %}
        <img
          src="{{ profile.avatar.url }}?w_150&h_150&c_thumb&g_face&q_auto:eco&f_auto"
          class="rounded-circle mb-2 avatar-sm avatar-circle"
          alt="{{ owner.username }}'s avatar"
          loading="lazy"
        />
        {% else %}
        <div class="avatar-initials mb-2">{{ initials }}</div>
        {% endif %}
        <h4>{{ profile.display_name|default:owner.username }}</h4>
        <div class="profile-bio-container">
          <p class="profile-bio text-break">{{ profile.bio }}</p>
        </div>
        {% endif %}
        <!-- Profile Stats -->
        <div class="profile-stats-container mb-4">
          <div class="profile-stats-row row text-center">
            <div class="profile-stats-col col-3">
              <div class="py-2">
                <div class="h5 mb-1 fw-bold stat-number">
                  {{ photos_count }}
                </div>
                <div>
                  <i class="fas fa-camera stat-icon"></i>
                </div>
              </div>
            </div>
            <div class="profile-stats-col col-3">
              <a
                href="{% url 'followers_list' username=owner.username %}"
                class="text-decoration-none"
              >
                <div class="py-2">
                  <div class="h5 mb-1 fw-bold stat-number">
                    {{ followers_count }}
                  </div>
                  <div>
                    <i class="fas fa-users stat-icon"></i>
                  </div>
                </div>
              </a>
            </div>
            <div class="profile-stats-col col-3">
              <a
                href="{% url 'following_list' username=owner.username %}"
                class="text-decoration-none"
              >
                <div class="py-2">
                  <div class="h5 mb-1 fw-bold stat-number">
                    {{ following_count }}
                  </div>
                  <div>
                    <i class="fas fa-user-plus stat-icon"></i>
                  </div>
                </div>
              </a>
            </div>
            <div class="profile-stats-col col-3">
              <div class="py-2">
                <div class="h5 mb-1 fw-bold stat-number">{{ total_likes }}</div>
                <div>
                  <i class="fas fa-heart stat-icon"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- end of template -->
        <!-- Profile Info -->
        <div class="profile-info mb-4">
          <div class="d-flex align-items-center text-muted mb-2">
            <i class="fas fa-calendar-alt me-2"></i>
            <span
              >Joined {{ joined|date:"M d, Y"|default:"[No join date]" }}</span
            >
          </div>
          <div class="d-flex align-items-center text-muted mb-2">
            <i class="fas fa-map-marker-alt me-2"></i>
            <span
              >{% if profile.location %}{{ profile.location }}{% else %}[No
              location]{% endif %}</span
            >
          </div>
          {% if profile and profile.website %}
            {% with prefix=profile.website|slice:':4' %}
              <a
                href="{% if prefix == 'http' %}{{ profile.website }}{% else %}https://{{ profile.website }}{% endif %}"
                target="_blank"
                rel="noopener noreferrer"
                class="text-decoration-none profile-link"
              >
                {{ profile.website|slice:':50' }}{% if profile.website|length > 50 %}...{% endif %}
              </a>
            {% endwith %}
          {% endif %}
          {% if profile.instagram %}
          <div class="d-flex align-items-center mb-2">
            <i class="fab fa-instagram me-2 text-muted"></i>
            <a
              href="https://instagram.com/{{ profile.instagram }}"
              target="_blank"
              rel="noopener"
              class="text-decoration-none profile-link"
            >
              @{{ profile.instagram }}
            </a>
          </div>
          {% endif %}
        </div>
        <!-- Action Buttons -->
        <div class="mt-3">
          {% if user.is_authenticated and user == owner %}
          <a
            href="{% url 'profile_edit_user' owner.username %}"
            class="btn btn-sm btn-primary me-2"
          >
            <i class="fas fa-edit me-1"></i>Edit profile
          </a>
          {% elif user.is_authenticated %}
          <button
            class="btn btn-sm btn-primary follow-btn"
            data-username="{{ owner.username }}"
            data-following="{{ is_following }}"
          >
            {% if is_following %}
            <i class="fas fa-user-minus me-1"></i>Unfollow {% else %}
            <i class="fas fa-user-plus me-1"></i>Follow {% endif %}
          </button>
          {% if owner.profile.show_email %}
          <a
            href="mailto:{{ owner.email }}"
            class="btn btn-sm btn-outline-secondary ms-2"
          >
            <i class="fas fa-envelope me-1"></i>Contact
          </a>
          {% endif %} {% else %}
          <a href="{% url 'login' %}" class="btn btn-sm btn-primary">
            <i class="fas fa-user-plus me-1"></i>Follow
          </a>
          {% if owner.profile.show_email %}
          <a
            href="mailto:{{ owner.email }}"
            class="btn btn-sm btn-outline-secondary ms-2"
          >
            <i class="fas fa-envelope me-1"></i>Contact
          </a>
          {% endif %} {% endif %}
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-9">
    <div class="profile-photos-section">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">Photos</h2>
        {% if user.is_authenticated and user == owner %}
        <a href="{% url 'upload_photo' %}" class="btn btn-primary btn-sm">
          <i class="fas fa-plus me-1 d-none d-md-inline"></i>
          <span class="d-none d-md-inline">Upload Photo</span>
          <i class="fas fa-plus d-md-none"></i>
        </a>
        {% endif %}
      </div>
      <div class="row g-4">
        {% for photo in photos %}
        <div class="col-sm-6 col-lg-4 mb-4">
          <div class="card photo-card">
            <div class="card-img-wrapper">
              <a href="{% url 'photo_detail' photo.id %}">
                <img
                  src="{{ photo.image.url }}?w_400&h_300&c_fill&q_auto:eco&f_auto"
                  class="card-img-top"
                  alt="{{ photo.title }}"
                  loading="lazy"
                />
              </a>
            </div>
            <div class="card-body">
              <h5 class="card-title">
                <a href="{% url 'photo_detail' photo.id %}"
                  >{{ photo.title }}</a
                >
              </h5>
              <p class="card-text">{{ photo.description|truncatewords:10 }}</p>
              <div
                class="d-flex justify-content-between align-items-center mt-2"
              >
                <div>
                  {% if photo.liked %}
                  <button
                    data-like-button
                    data-photo-id="{{ photo.id }}"
                    class="btn btn-sm btn-danger"
                  >
                    ♥ Liked
                  </button>
                  {% else %}
                  <button
                    data-like-button
                    data-photo-id="{{ photo.id }}"
                    class="btn btn-sm btn-outline-danger"
                  >
                    ♡ Like
                  </button>
                  {% endif %}
                  <small class="ms-2" data-likes-count="{{ photo.id }}"
                    >{{ photo.likes.count }}</small
                  >
                </div>
                <div>
                  <a
                    href="{% url 'photo_detail' photo.id %}"
                    class="btn btn-sm btn-secondary"
                    >Comment</a
                  >
                  {% if user.is_authenticated and user == owner %}
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-danger ms-1"
                    data-bs-toggle="modal"
                    data-bs-target="#deletePhotoModal"
                    data-photo-id="{{ photo.id }}"
                    data-photo-title="{{ photo.title }}"
                    data-photo-image="{{ photo.image.url }}"
                  >
                    <i class="fas fa-trash"></i>
                  </button>
                  {% endif %}
                </div>
              </div>
              <!-- Comments -->
              <div class="mt-3">
                {% with photo.comments.all|slice:":5" as recent_comments %}
                  {% if recent_comments %}
                    <ul class="list-unstyled mb-0">
                      {% for comment in recent_comments %}
                        <li class="py-1 border-bottom">
                          <strong>{{ comment.author.username }}</strong>
                          <small class="text-muted">· {{ comment.created_at|date:"M d, Y H:i" }}</small>
                          <div>{{ comment.text }}</div>
                          {% if user.is_authenticated %}
                            {% if comment.author == user or user == photo.owner %}
                              <div class="mt-2">
                                {% if comment.author == user %}
                                  <a href="{% url 'edit_comment' comment.id %}" class="btn btn-sm btn-outline-secondary me-2">
                                    <i class="fas fa-edit"></i> Edit
                                  </a>
                                {% endif %}
                                <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteCommentModal" data-comment-id="{{ comment.id }}" data-comment-author="{{ comment.author.username }}" data-comment-text="{{ comment.text }}" data-comment-date="{{ comment.created_at|date:'M d, Y H:i' }}" data-photo-title="{{ photo.title }}">
                                  <i class="fas fa-trash"></i> Delete{% if user == photo.owner and comment.author != user %} (as photo owner){% endif %}
                                </button>
                              </div>
                            {% endif %}
                          {% endif %}
                        </li>
                      {% endfor %}
                    </ul>
                  {% endif %}
                {% endwith %}
              </div>
            </div>
          </div>
        </div>
        {% empty %}
        <div class="col-12">
          <div class="alert alert-info">No photos uploaded yet.</div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
